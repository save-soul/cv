---
import { siteConfig, menuLinks } from '@/site-config'
import { getCurrentLocale } from '@/utils/locale'

const currentLocale = getCurrentLocale(Astro.url)
const isZhCn = currentLocale === 'zh-cn'
const currentSiteConfig = siteConfig[currentLocale]
const currentMenuLinks = menuLinks[currentLocale]
---

<header class='mb-12 flex w-full flex-wrap pb-3 text-sm sm:flex-nowrap sm:justify-start'>
  <nav
    class='relative mx-auto flex w-full items-center justify-between sm:flex sm:items-center'
    aria-label='global'
  >
    <div class="flex items-center justify-between w-full sm:w-auto">
      <a class='flex-none text-xl font-semibold' href='/' aria-label='Brand'>{currentSiteConfig.author}</a>
      
      {/* 汉堡菜单按钮 (仅在移动端显示) */}
      <button
        id="hamburger"
        class="ml-4 sm:hidden rounded-md border border-border p-1.5 transition-all hover:bg-border focus:outline-none"
        aria-label={isZhCn ? '打开菜单' : 'Open menu'}
        aria-expanded="false"
      >
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width="24" 
          height="24" 
          viewBox="0 0 24 24"
          class="h-5 w-5"
        >
          <path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
      </button>
    </div>

    {/* 导航菜单 (桌面端显示) */}
    <div id="desktop-nav" class='hidden sm:flex flex-row items-center justify-center gap-x-5 sm:gap-x-7'>
      {currentMenuLinks.map((link) => (
        <a
          href={link.path}
          class='flex-none text-[1.05rem] font-medium hover:text-foreground/75'
          aria-label={link.title}
          target='_blank'
        >
          {link.title}
        </a>
      ))}
      {/* 语言切换和主题按钮 */}
      <a
        href={isZhCn ? '/' : '/zh-cn/'}
        class='relative rounded-md border border-border p-1.5 transition-all hover:bg-border'
        title={isZhCn ? 'Switch to English' : '切换到中文'}
      >
        <span class='sr-only'>{isZhCn ? 'Switch to English' : '切换到中文'}</span>
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='32'
          height='32'
          viewBox='0 0 24 24'
          class='h-[1.2rem] w-[1.2rem] transition-all'
        >
          <path
            fill='currentColor'
            d='M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z'
          />
        </svg>
      </a>
      <button
        id='toggleDarkMode'
        class='relative rounded-md border border-border p-1.5 transition-all hover:bg-border'
      >
        <span class='sr-only'>Dark Theme</span>
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='32'
          height='32'
          viewBox='0 0 24 24'
          class='h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:hidden dark:-rotate-90 dark:scale-0'
          ><path
            fill='currentColor'
            d='M12 15q1.25 0 2.125-.875T15 12q0-1.25-.875-2.125T12 9q-1.25 0-2.125.875T9 12q0 1.25.875 2.125T12 15m0 1q-1.671 0-2.836-1.164T8 12q0-1.671 1.164-2.836T12 8q1.671 0 2.836 1.164T16 12q0 1.671-1.164 2.836T12 16m-7-3.5H1.5v-1H5zm17.5 0H19v-1h3.5zM11.5 5V1.5h1V5zm0 17.5V19h1v3.5zM6.746 7.404l-2.16-2.098l.695-.744l2.111 2.134zM18.72 19.438l-2.117-2.14l.652-.702l2.16 2.098zM16.596 6.746l2.098-2.16l.744.695l-2.134 2.111zM4.562 18.72l2.14-2.117l.663.652l-2.078 2.179zM12 12'
          ></path></svg
        >
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='32'
          height='32'
          viewBox='0 0 24 24'
          class='hidden h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:block dark:rotate-0 dark:scale-100'
          ><path
            fill='currentColor'
            d='M12.058 20q-3.334 0-5.667-2.333Q4.058 15.333 4.058 12q0-3.038 1.98-5.27Q8.02 4.5 10.942 4.097q.081 0 .159.006t.153.017q-.506.706-.801 1.57q-.295.865-.295 1.811q0 2.667 1.866 4.533q1.867 1.867 4.534 1.867q.952 0 1.813-.295q.862-.295 1.548-.801q.012.075.018.153q.005.078.005.158q-.384 2.923-2.615 4.904T12.057 20'
          ></path></svg
        >
      </button>
    </div>
  </nav>

  {/* 移动端导航菜单 (默认隐藏) */}
  <div id="mobile-menu" class="hidden w-full sm:hidden bg-background dark:bg-dark-background">
    <div class="py-4 flex flex-col gap-y-3">
      {currentMenuLinks.map((link) => (
        <a
          href={link.path}
          class='px-4 py-2 text-lg font-medium hover:bg-foreground/10'
          aria-label={link.title}
          target='_blank'
        >
          {link.title}
        </a>
      ))}
      <div class="flex gap-x-4 px-4 pt-2">
        <a
          href={isZhCn ? '/' : '/zh-cn/'}
          class='flex-1 flex items-center justify-center rounded-md border border-border p-2.5 transition-all hover:bg-border'
          title={isZhCn ? 'Switch to English' : '切换到中文'}
        >
          <span class='sr-only'>{isZhCn ? 'Switch to English' : '切换到中文'}</span>
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='32'
            height='32'
            viewBox='0 0 24 24'
            class='h-5 w-5'
          >
            <path
              fill='currentColor'
              d='M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z'
            />
          </svg>
        </a>
        <button
          class='flex-1 flex items-center justify-center rounded-md border border-border p-2.5 transition-all hover:bg-border'
          id='toggleDarkModeMobile'
        >
          <span class='sr-only'>Dark Theme</span>
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='32'
            height='32'
            viewBox='0 0 24 24'
            class='h-5 w-5 rotate-0 scale-100 transition-all dark:hidden dark:-rotate-90 dark:scale-0'
            ><path
              fill='currentColor'
              d='M12 15q1.25 0 2.125-.875T15 12q0-1.25-.875-2.125T12 9q-1.25 0-2.125.875T9 12q0 1.25.875 2.125T12 15m0 1q-1.671 0-2.836-1.164T8 12q0-1.671 1.164-2.836T12 8q1.671 0 2.836 1.164T16 12q0 1.671-1.164 2.836T12 16m-7-3.5H1.5v-1H5zm17.5 0H19v-1h3.5zM11.5 5V1.5h1V5zm0 17.5V19h1v3.5zM6.746 7.404l-2.16-2.098l.695-.744l2.111 2.134zM18.72 19.438l-2.117-2.14l.652-.702l2.16 2.098zM16.596 6.746l2.098-2.16l.744.695l-2.134 2.111zM4.562 18.72l2.14-2.117l.663.652l-2.078 2.179zM12 12'
            ></path></svg
          >
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='32'
            height='32'
            viewBox='0 0 24 24'
            class='hidden h-5 w-5 rotate-90 scale-0 transition-all dark:block dark:rotate-0 dark:scale-100'
            ><path
              fill='currentColor'
              d='M12.058 20q-3.334 0-5.667-2.333Q4.058 15.333 4.058 12q0-3.038 1.98-5.27Q8.02 4.5 10.942 4.097q.081 0 .159.006t.153.017q-.506.706-.801 1.57q-.295.865-.295 1.811q0 2.667 1.866 4.533q1.867 1.867 4.534 1.867q.952 0 1.813-.295q.862-.295 1.548-.801q.012.075.018.153q.005.078.005.158q-.384 2.923-2.615 4.904T12.057 20'
            ></path></svg
          >
        </button>
      </div>
    </div>
  </div>
</header>

<script>
  function getCurrentTheme() {
    return localStorage.getItem('theme')
  }

  // 修复：添加明确的参数类型声明
  /**
   * @param {string} buttonId
   */
  function setupThemeToggle(buttonId: string) {
    const button = document.getElementById(buttonId)
    button?.addEventListener('click', () => {
      const theme = getCurrentTheme() === 'light' ? 'dark' : 'light'
      const toggleDarkModeEvent = new CustomEvent('theme-change', {
        detail: { theme }
      })
      document.dispatchEvent(toggleDarkModeEvent)
    })
  }

  // 初始化主题切换按钮
  setupThemeToggle('toggleDarkMode')
  setupThemeToggle('toggleDarkModeMobile')

  // 汉堡菜单功能
  const hamburger = document.getElementById('hamburger')
  const mobileMenu = document.getElementById('mobile-menu')
  
  if (hamburger && mobileMenu) {
    hamburger.addEventListener('click', () => {
      const isExpanded = hamburger.getAttribute('aria-expanded') === 'true'
      hamburger.setAttribute('aria-expanded', String(!isExpanded))
      mobileMenu.classList.toggle('hidden')
      
      // 更新汉堡图标
      if (!isExpanded) {
        hamburger.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="h-5 w-5">
            <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/>
          </svg>
        `
      } else {
        hamburger.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="h-5 w-5">
            <path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        `
      }
    })
    
    // 点击菜单项关闭菜单
    mobileMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden')
        hamburger.setAttribute('aria-expanded', 'false')
        hamburger.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="h-5 w-5">
            <path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        `
      })
    })
  }
</script>